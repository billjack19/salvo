function executaAplicacao(){
    if(modeloCertificado == 1){
        return true;
    }else{
        $('#carregando').show();
        $.browser.chrome = /chrom(e|ium)/.test(navigator.userAgent.toLowerCase());
        if(!$.browser.chrome){
            parent.bootbox.error('Este navegador não é compatível com o aplicativo, utilize o navegador Google Chrome');
            $('#carregando').hide();
            return false;
        }
        return $.ajax({
            url: urlEnvio+'/iniciar_conexao',
            type: 'POST',
            data: formataDadosJson({nomeApp:nomeApp, urlApp:urlApp, iconeApp:iconeApp}),
            contentType: 'application/json',
            dataType: 'json',
            error:function(){
                parent.bootbox.error('O aplicativo desktop não está em execução!');
                $('#carregando').hide();
            },
        });
    }
}
function formataMensagemErro(){
    return (modeloCertificado == 1 ? 'Ocorreu um erro, verifique sua conexão com a internet!' : 'Ocorreu um erro com o aplicativo desktop!');
}
function formataDadosJson(dados){
    return (modeloCertificado == 1 ? dados : JSON.stringify(dados));
}
function formataConteudoJson(dados){
    return (modeloCertificado == 1 ? 'application/x-www-form-urlencoded' : 'application/json');
}
function validaCertificadoA3(){
    $.when(executaAplicacao()).done(function(retorno){
        if(retorno){
            $('#carregando').show();
            $.ajax({
                type: 'POST',
                url: urlEnvio+'/validar_certificado',
                success: function(retorno) {
                    if(retorno.sucesso == true){
                        $.post('/configuracoes/certificado_digital', {salvaA3:true, serie: retorno.serie, validade: retorno.validade_certificado}, function(retorno){
                            if(retorno == 0){
                                bootbox.error('Já existe um certificado digital A3 vinculado!');
                                $('#carregando').hide();
                            }else if(retorno == 1){
                                location.href = window.location;
                            }else{
                                bootbox.error('Ocorreu um erro ao vincular o certificado!');
                                $('#carregando').hide();
                            }
                        });
                    }else{
                        bootbox.error(retorno.mensagem);
                        $('#carregando').hide();
                    }
                },
                error: function(result) {
                    bootbox.error('O aplicativo desktop não está em execução!');
                    $('#carregando').hide();
                }
            });
        }
    });
}

var nfcBalcao = false;

function envia(id){
    $.when(executaAplicacao()).done(function(retorno){
        if(retorno){
            $('#carregando').show();
            $.ajax({
                type: 'POST',
                url: '/fiscal/nfe'+versaoNf+'/envia/'+id,
                contentType: 'application/json',
                dataType: 'json',
                success: function(retEN){
                    if(retEN.sucesso == true){
                        xml = retEN.xml;
                        recibo = retEN.recibo;
                        autorizacao = retEN.autorizacao;
                        $.ajax({
                            type: 'POST',
                            url: urlEnvio+'/assina_xml',
                            data: formataDadosJson({autorizacao: autorizacao, xml:xml, serie:retEN.serie}),
                            contentType: formataConteudoJson(),
                            dataType: 'json',
                            success: function(retAssinaXml){
                                if(retAssinaXml.sucesso == true){
                                    xmlAssinado = retAssinaXml.xml;
                                    $.ajax({
                                        type: 'POST',
                                        url: '/fiscal/nfe'+versaoNf+'/valida_xml',
                                        data: {xmlAssinado:xmlAssinado, autorizacao:autorizacao},
                                        contentType: 'application/x-www-form-urlencoded',
                                        dataType: 'json',
                                        success: function(retValidaXml){
                                            if(retValidaXml.sucesso == true){
                                                xmlAssinado = retValidaXml.xml;
                                                $.ajax({
                                                    type: 'POST',
                                                    url: urlEnvio+'/autoriza_envio',
                                                    data: formataDadosJson({xmlAssinado:xmlAssinado, recibo:recibo, autorizacao:autorizacao, ambiente:retEN.ambiente, cUF:retEN.cUF, servicos: retEN.servicos}),
                                                    contentType: formataConteudoJson(),
                                                    dataType: 'json',
                                                    success: function(retAutorizaXml){
                                                        if(retAutorizaXml.sucesso == true){
                                                            recibo = retAutorizaXml.recibo;
                                                            $.ajax({
                                                                type: 'POST',
                                                                url: '/fiscal/nfe'+versaoNf+'/salva_xml_assinado',
                                                                data: {id:id, xmlAssinado:xmlAssinado, recibo:recibo, autorizacao:autorizacao},
                                                                contentType: 'application/x-www-form-urlencoded',
                                                                dataType: 'json',
                                                                success: function(retSalvaXmlAssinado){
                                                                    if(retSalvaXmlAssinado.sucesso == true){
                                                                        $.ajax({
                                                                            type: 'POST',
                                                                            url: urlEnvio+'/consulta_envio',
                                                                            data: formataDadosJson({recibo:recibo, autorizacao:autorizacao, ambiente:retEN.ambiente, cUF:retEN.cUF, servicos: retEN.servicos}),
                                                                            contentType: formataConteudoJson(),
                                                                            dataType: 'json',
                                                                            success: function(retConsultaXml){
                                                                                if(retConsultaXml.sucesso == true){
                                                                                    $.ajax({
                                                                                        type: 'POST',
                                                                                        url: '/fiscal/nfe'+versaoNf+'/valida_envio',
                                                                                        contentType: 'application/x-www-form-urlencoded',
                                                                                        dataType: 'json',
                                                                                        data: {id:id, xmlAssinado:xmlAssinado, autorizacao:autorizacao, retorno: retConsultaXml.retorno},
                                                                                        success: function(retValidaConsulta){
                                                                                            if(nfcBalcao == true){
                                                                                                retornoNfc = {
                                                                                                    id: id,
                                                                                                    situacao: retValidaConsulta.sucesso,
                                                                                                    mensagem: retValidaConsulta.mensagem,
                                                                                                };
                                                                                                pegaRetornoNfc(retornoNfc);
                                                                                            }else{
                                                                                                $.ajax({
                                                                                                    type: 'POST',
                                                                                                    url: '/fiscal/nfe'+versaoNf+'/formata_mensagem_envio',
                                                                                                    contentType: 'application/x-www-form-urlencoded',
                                                                                                    dataType: 'json',
                                                                                                    data: {sucesso: retValidaConsulta.sucesso, mensagem:retValidaConsulta.mensagem},
                                                                                                    success: function(){
                                                                                                        location.href = window.location;
                                                                                                    },
                                                                                                    error:function(){
                                                                                                        $('#carregando').hide();
                                                                                                        bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                                                                                                    },
                                                                                                });
                                                                                            }
                                                                                        },
                                                                                        error:function(){
                                                                                            $('#carregando').hide();
                                                                                            bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                                                                                        },
                                                                                    });
                                                                                }else{
                                                                                    $('#carregando').hide();
                                                                                    bootbox.error(retConsultaXml.mensagem);
                                                                                }
                                                                            },
                                                                            error:function(){
                                                                                $('#carregando').hide();
                                                                                bootbox.error(formataMensagemErro());
                                                                            },
                                                                        });
                                                                    }else{
                                                                        $('#carregando').hide();
                                                                        bootbox.error(retSalvaXmlAssinado.mensagem);
                                                                    }
                                                                },
                                                                error:function(){
                                                                    $('#carregando').hide();
                                                                    bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                                                                },
                                                            });
                                                        }else{
                                                            $('#carregando').hide();
                                                            bootbox.error(retAutorizaXml.mensagem);
                                                        }
                                                    },
                                                    error:function(){
                                                        $('#carregando').hide();
                                                        bootbox.error(formataMensagemErro());
                                                    },
                                                });
                                            }else{
                                                $('#carregando').hide();
                                                bootbox.error(retValidaXml.mensagem);
                                            }
                                        },
                                        error:function(){
                                            $('#carregando').hide();
                                            bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                                        },
                                    });
                                }else{
                                    $('#carregando').hide();
                                    bootbox.error(retAssinaXml.mensagem);
                                }
                            },
                            error:function(){
                                $('#carregando').hide();
                                bootbox.error(formataMensagemErro());
                            },
                        });
                    }else{
                        $('#carregando').hide();
                        bootbox.error(retEN.mensagem);
                    }
                },
                error:function(){
                    $('#carregando').hide();
                    bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                },
            });
        }
    });
}

function corrigi(id){
    $.when(executaAplicacao()).done(function(retorno){
        if(retorno){
            parent.$('#carregando').show();
            $.ajax({
                type: 'POST',
                url: '/fiscal/nfe'+versaoNf+'/corrigi/'+id,
                contentType: 'application/x-www-form-urlencoded',
                dataType: 'json',
                data: $('form').serialize(),
                success: function(retEN){
                    if(retEN.sucesso == true){
                        $.ajax({
                            type: 'POST',
                            url: urlEnvio+'/assina_xml',
                            data: formataDadosJson({autorizacao: retEN.autorizacao, xml:retEN.xml, serie:retEN.serie, correcao:true}),
                            contentType: formataConteudoJson(),
                            dataType: 'json',
                            success: function(retAssinaXml){
                                if(retAssinaXml.sucesso == true){
                                    $.ajax({
                                        type: 'POST',
                                        url: '/fiscal/nfe'+versaoNf+'/salva_xml_assinado',
                                        data: {id:id, xmlAssinado:retAssinaXml.xml, correcao:true, autorizacao:retEN.autorizacao},
                                        contentType: 'application/x-www-form-urlencoded',
                                        dataType: 'json',
                                        success: function(retSalvaXmlAssinado){
                                            if(retSalvaXmlAssinado.sucesso == true){
                                                $.ajax({
                                                    type: 'POST',
                                                    url: urlEnvio+'/autoriza_correcao',
                                                    data: formataDadosJson({xmlAssinado:retSalvaXmlAssinado.xml, autorizacao:retEN.autorizacao, ambiente:retEN.ambiente, cUF:retEN.cUF, servicos: retEN.servicos}),
                                                    contentType: formataConteudoJson(),
                                                    dataType: 'json',
                                                    success: function(retAutorizaCorrecao){
                                                        if(retAutorizaCorrecao.sucesso == true){
                                                            $.ajax({
                                                                type: 'POST',
                                                                url: '/fiscal/nfe'+versaoNf+'/valida_correcao',
                                                                contentType: 'application/x-www-form-urlencoded',
                                                                dataType: 'json',
                                                                data: {id:id, xmlAssinado: retSalvaXmlAssinado.xml, autorizacao:retEN.autorizacao, retorno: retAutorizaCorrecao.retorno},
                                                                success: function(retValidaConsulta){
                                                                    if(retValidaConsulta.sucesso == true){
                                                                        parent.location.href = parent.window.location;
                                                                    }else{
                                                                        parent.$('#carregando').hide();
                                                                        parent.bootbox.error(retValidaConsulta.mensagem);
                                                                    }
                                                                },
                                                                error:function(){
                                                                    parent.$('#carregando').hide();
                                                                    parent.bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                                                                },
                                                            });
                                                        }else{
                                                            parent.$('#carregando').hide();
                                                            parent.bootbox.error(retAutorizaCorrecao.mensagem);
                                                        }
                                                    },
                                                    error:function(){
                                                        parent.$('#carregando').hide();
                                                        parent.bootbox.error(formataMensagemErro());
                                                    },
                                                });
                                            }else{
                                                parent.$('#carregando').hide();
                                                parent.bootbox.error(retSalvaXmlAssinado.mensagem);
                                            }
                                       },
                                       error:function(){
                                            parent.$('#carregando').hide();
                                            parent.bootbox.error(formataMensagemErro());
                                       },
                                    });
                                }else{
                                    parent.$('#carregando').hide();
                                    parent.bootbox.error(retAssinaXml.mensagem);
                                }
                            },
                            error:function(){
                                parent.$('#carregando').hide();
                                parent.bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                            },
                        });
                    }else{
                        parent.$('#carregando').hide();
                        parent.bootbox.error(retEN.mensagem);
                    }
                },
                error:function(){
                    parent.$('#carregando').hide();
                    parent.bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                },
            });
        }
    });
}

function cancela(id){
    $.when(executaAplicacao()).done(function(retorno){
        if(retorno){
            parent.$('#carregando').show();
        	$.ajax({
                type: 'POST',
                url: '/fiscal/nfe'+versaoNf+'/cancela/'+id,
                contentType: 'application/x-www-form-urlencoded',
                dataType: 'json',
                data: $('form').serialize(),
                success: function(retEN){
                    if(retEN.sucesso == true){
                        $.ajax({
                            type: 'POST',
                            url: urlEnvio+'/assina_xml',
                            data: formataDadosJson({autorizacao: retEN.autorizacao, xml:retEN.xml, serie:retEN.serie, cancelamento:true}),
                            contentType: formataConteudoJson(),
                            dataType: 'json',
                            success: function(retAssinaXml){
                                if(retAssinaXml.sucesso == true){
                                    $.ajax({
                                        type: 'POST',
                                        url: '/fiscal/nfe'+versaoNf+'/salva_xml_assinado',
                                        data: {id:id, xmlAssinado:retAssinaXml.xml, cancelamento:true, autorizacao:retEN.autorizacao},
                                        contentType: 'application/x-www-form-urlencoded',
                                        dataType: 'json',
                                        success: function(retSalvaXmlAssinado){
                                            if(retSalvaXmlAssinado.sucesso == true){
                                                $.ajax({
                                                    type: 'POST',
                                                    url: urlEnvio+'/autoriza_cancelamento',
                                                    data: formataDadosJson({xmlAssinado:retSalvaXmlAssinado.xml, autorizacao:retEN.autorizacao, ambiente:retEN.ambiente, cUF:retEN.cUF, servicos: retEN.servicos}),
                                                    contentType: formataConteudoJson(),
                                                    dataType: 'json',
                                                    success: function(retAutorizaCancelamento){
                                                        if(retAutorizaCancelamento.sucesso == true){
                                                            $.ajax({
                                                                type: 'POST',
                                                                url: '/fiscal/nfe'+versaoNf+'/valida_cancelamento',
                                                                contentType: 'application/x-www-form-urlencoded',
                                                                dataType: 'json',
                                                                data: {id:id, xmlAssinado: retSalvaXmlAssinado.xml, autorizacao:retEN.autorizacao, retorno: retAutorizaCancelamento.retorno},
                                                                success: function(retValidaConsulta){
                                                                    if(retValidaConsulta.sucesso == true){
                                                                        parent.location.href = parent.window.location;
                                                                    }else{
                                                                        parent.$('#carregando').hide();
                                                                        parent.bootbox.error(retValidaConsulta.mensagem);
                                                                    }
                                                                },
                                                                error:function(){
                                                                    parent.$('#carregando').hide();
                                                                    parent.bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                                                                },
                                                            });
                                                        }else{
                                                            parent.$('#carregando').hide();
                                                            parent.bootbox.error(retAutorizaCancelamento.mensagem);
                                                        }
                                                    },
                                                    error:function(){
                                                        parent.$('#carregando').hide();
                                                        parent.bootbox.error(formataMensagemErro());
                                                    },
                                                });
                                            }else{
                                                parent.$('#carregando').hide();
                                                parent.bootbox.error(retSalvaXmlAssinado.mensagem);
                                            }
                                       },
                                       error:function(){
                                            parent.$('#carregando').hide();
                                            parent.bootbox.error(formataMensagemErro());
                                       },
                                    });
                                }else{
                                    parent.$('#carregando').hide();
                                    parent.bootbox.error(retAssinaXml.mensagem);
                                }
                            },
                            error:function(){
                                parent.$('#carregando').hide();
                                parent.bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                            },
                        });
                    }else{
                        parent.$('#carregando').hide();
                        parent.bootbox.error(retEN.mensagem);
                    }
                },
                error:function(){
                    parent.$('#carregando').hide();
                    parent.bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                },
            });
        }
    });
}

function inutilizaNumeracao(){
    $.when(executaAplicacao()).done(function(retorno){
        if(retorno){
            parent.$('#carregando').show();
        	$.ajax({
                type: 'POST',
                url: '/fiscal/nfe'+versaoNf+'/inutiliza_numeracao',
                contentType: 'application/x-www-form-urlencoded',
                dataType: 'json',
                data: $('form').serialize(),
                success: function(retEN){
                     if(retEN.sucesso == true){
                        $.ajax({
                            type: 'POST',
                            url: urlEnvio+'/assina_xml',
                            data: formataDadosJson({autorizacao: retEN.autorizacao, xml:retEN.xml, serie:retEN.serie, inutilizacao:true}),
                            contentType: formataConteudoJson(),
                            dataType: 'json',
                            success: function(retAssinaXml){
                                if(retAssinaXml.sucesso == true){
                                    $.ajax({
                                        type: 'POST',
                                        url: '/fiscal/nfe'+versaoNf+'/salva_xml_assinado',
                                        data: {xmlAssinado:retAssinaXml.xml, inutilizacao:true, autorizacao:retEN.autorizacao, idEvento:retEN.idEvento},
                                        contentType: 'application/x-www-form-urlencoded',
                                        dataType: 'json',
                                        success: function(retSalvaXmlAssinado){
                                           if(retSalvaXmlAssinado.sucesso == true){
                                                $.ajax({
                                                    type: 'POST',
                                                    url: urlEnvio+'/autoriza_inutilizacao',
                                                    data: formataDadosJson({xmlAssinado:retSalvaXmlAssinado.xml, autorizacao:retEN.autorizacao, ambiente:retEN.ambiente, cUF:retEN.cUF, servicos: retEN.servicos}),
                                                    contentType: formataConteudoJson(),
                                                    dataType: 'json',
                                                    success: function(retAutorizaInutilizacao){
                                                        if(retAutorizaInutilizacao.sucesso == true){
                                                            $.ajax({
                                                                type: 'POST',
                                                                url: '/fiscal/nfe'+versaoNf+'/valida_inutilizacao',
                                                                contentType: 'application/x-www-form-urlencoded',
                                                                dataType: 'json',
                                                                data: {xmlAssinado: retSalvaXmlAssinado.xml, autorizacao:retEN.autorizacao, idEvento:retEN.idEvento, retorno: retAutorizaInutilizacao.retorno},
                                                                success: function(retValidaConsulta){
                                                                    if(retValidaConsulta.sucesso == true){
                                                                        parent.location.href = parent.window.location;
                                                                    }else{
                                                                        parent.$('#carregando').hide();
                                                                        parent.bootbox.error(retValidaConsulta.mensagem);
                                                                    }
                                                                },
                                                                error:function(){
                                                                    parent.$('#carregando').hide();
                                                                    parent.bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                                                                },
                                                            });
                                                        }else{
                                                            parent.$('#carregando').hide();
                                                            parent.bootbox.error(retAutorizaInutilizacao.mensagem);
                                                        }
                                                    },
                                                    error:function(){
                                                        parent.$('#carregando').hide();
                                                        parent.bootbox.error(formataMensagemErro());
                                                    },
                                                });
                                            }else{
                                                parent.$('#carregando').hide();
                                                parent.bootbox.error(retSalvaXmlAssinado.mensagem);
                                            }
                                       },
                                       error:function(){
                                            parent.$('#carregando').hide();
                                            parent.bootbox.error(formataMensagemErro());
                                       },
                                    });
                                }else{
                                    parent.$('#carregando').hide();
                                    parent.bootbox.error(retAssinaXml.mensagem);
                                }
                            },
                            error:function(){
                                parent.$('#carregando').hide();
                                parent.bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                            },
                        });
                    }else{
                        parent.$('#carregando').hide();
                        parent.bootbox.error(retEN.mensagem);
                    }
                },
                error:function(){
                    parent.$('#carregando').hide();
                    parent.bootbox.error('Ocorreu um erro, verifique sua conexão com a internet!');
                },
            });
        }
    });
}