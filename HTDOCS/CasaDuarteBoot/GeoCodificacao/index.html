<!DOCTYPE html>
<html>
<head>
	<title>Geocodificação Automatica</title>
	<script>
		/* IP do Web Service */
		// var hostWebService = "192.168.100.15";
		// var hostWebService = "192.168.100.23";
		var hostWebService = "localhost";

		/* IP das Imagens do servidor */
		// var hostServeImage = "192.168.0.105";
		// var hostServeImage = "localhost";

		var portaWebService = ":8080";
		// var portaImgService = "8088";

		var caminhoWebService = "/Casa_Duarte/app/";
		var urlWebService = "http://"+hostWebService+portaWebService+caminhoWebService;
		var parametrosWebService = "?tagmode=any&jsoncallback=?";
		var listagem = false;

		var vendedor = 0;
		var filialGearl = 0;
		var sequencia = 0;
		var documentoGeral = "";
	</script>
	<meta charset="utf-8">

	<script type="text/javascript" src="js/jQuery.js"></script>

	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="css/estilo.css">
	<link rel="stylesheet" type="text/css" href="css/font-awesome/css/font-awesome.min.css">

	<!-- Scrips padrão -->
	<script type="text/javascript" src="js/scripts.js"></script>
	<script type="text/javascript" src="js/bootstrap.js"></script>

	<script type="text/javascript" src="js/bootbox.js"></script>
	<script type="text/javascript" src="js/masked2.js"></script>
	<script type="text/javascript" src="js/masked.js"></script>
	<script type="text/javascript" src="js/toast.js"></script>
	<script type="text/javascript" src="js/maskmoney.js"></script>
	<script type="text/javascript" src="js/moment.js"></script>

	<!-- Biblioteca dataList usando Jquery  -->
	<link href="lb/jquery-flexdatalist/jquery.flexdatalist.min.css" rel="stylesheet" type="text/css">
	<script src="lb/jquery-flexdatalist/jquery.flexdatalist.min.js"></script>

	<script src="js/jquery.maskMoney.min.js" type="text/javascript"></script>
	<link rel="stylesheet" type="text/css" href="css/toast.css">

</head>
<body onload="criarBancoDeDados();">
	<div class="col-xs-12">
		<h2>Geocodificação Automatica</h2>
		<br>

		<div class="col-xs-4 classeCaixaDialog">
			<h1>Última busca feita</h1>
			<br>
			<div id="buscado" style="margin-left: 15px;">
				Carregando...
			</div>
			<br><br>
		</div>
		<div class="col-xs-4 text-center">
			<!-- Colocar um gif de processando -->
			<img src="img/loading.gif" width="50%">
		</div>
		<div class="col-xs-4 classeCaixaDialog">
			<h1>Últimos Processos</h1>
			<br>
			<div id="ultimosProcesso">Nenhum Registro Encontrado</div>
			<br><br>
		</div>
		<div class="col-xs-12">
			<br><br><br><br><br>
		</div>
	</div>
	
	<style type="text/css">
		.classeCaixaDialog{
			border-style: black;
			border-radius: 10px;
			box-shadow: 10px 10px 5px lightgray;
		}
	</style>
</body>





<footer class="fixed-bottom">
	<div class="row">
		<div class="col-md-12" style="background-color: #fff;">
			<table class="table">
				<tr>
					<td align="left">
						<div id="botaoVoltarFixo">
						</div>
					</td>
					<td align="right">
						<div id="botaoSairCaminhao">
							<button class="btn btn-info" data-toggle='modal' data-target='#modalConfiguraIp'>
								<i class="fa fa-cog" aria-hidden="true"></i>&nbsp;&nbsp;Configurar IP
							</button>
						</div>
					</td>
				</tr>
			</table>
		</div>
	</div>
</footer>





<!-- ******************************************************************************************** -->
<!-- ** Modal configura ip * -->
<!-- ******************************************************************************************** -->
<div class="modal fade" id="modalConfiguraIp" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" onclick="setarIpCampoConfig();"  id="fecharModalIpBottun" data-dismiss="modal">&times;</button>
				<h4 class="modal-title">Configurar IP: <b><span id="modalNomeItem"></span></b></h4>
			</div>
			<div class="modal-body">
				<div id="divAutenticaIP">
					<label class="label-float" for="name">Uuário: <span style="color: red;">*</span></label>
					<input id="modalUsuarioIPConfig" type="text" class="form-control" required>

					<label class="label-float" for="name">Chave: <span style="color: red;">*</span></label>
					<input id="modalChaveIPConfig" type="password" class="form-control" required>
					<button onclick='autenticarIp();' class="btn btn-success btn-block" style="margin-top: 15px;">Autenticar</button>
					<br>
					<button class="btn btn-primary btn-block" onclick="testeConectServer();">Ping</button>
				</div>
				<div id="divOcultarIp" class="hidden">
					<label class="label-float" for="name">IP: <span style="color: red;">*</span></label>
					<input id="modalIpConfig" type="text" class="form-control" required>

					<label class="label-float" for="name">Porta: <span style="color: red;">*</span></label>
					<input id="modalPortaConfig" type="tel" class="form-control" required>

					<label class="label-float" for="name">Uuário: <span style="color: red;">*</span></label>
					<input id="modalUsuarioConfig" type="text" class="form-control" required>

					<label class="label-float" for="name">Chave: <span style="color: red;">*</span></label>
					<input id="modalChaveConfig" type="password" class="form-control" required>
				</div>
				<br>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-success hidden" id="confimerIpButton" onclick="adicionarIp($('#modalIpConfig').val());">
					Confirmar IP
				</button>
				<button type="button" class="btn btn-default" onclick="setarIpCampoConfig();" data-dismiss="modal">
					Fechar
				</button>
			</div>
		</div>
	</div>
</div>






<script src="js/ajax/ajax_sql.js"></script>
<script src="js/ajax/ajax_outros.js"></script>
<script type="text/javascript">
	function testeConectServer(){
		$.ajax({
			url: urlWebService+"Ping/ping"+parametrosWebService,
			type: 'GET',
			contentType: "application/json",
			jsonpCallback: "localJsonpCallback",
			error: function(){
				var info = "<i class='fa fa-asterisk' style='color:red'></i>&nbsp;&nbsp;Sem conexão!";
				$("#botaoVoltarFixo").html(info);
				toastGeral("error", "Sem conexão com o servidor!")
			}
		}).done( function(data){
			var info = "<i class='fa fa-asterisk' style='color:green'></i>&nbsp;&nbsp;Você está conectado!";
			if(data == "1") $("#botaoVoltarFixo").html(info);
		});
	}


	setInterval( function(){ buscarEnderecos(); buscarEnderecos2(); }, 15000);

	function buscarEnderecos(){
		$.ajax({
			url: urlWebService+"EnderecoWs/listar"+parametrosWebService,
			type: 'GET',
			contentType: "application/json",
			jsonpCallback: "localJsonpCallback",
			error: function(){
				var info = "<i class='fa fa-asterisk' style='color:red'></i>&nbsp;&nbsp;Sem conexão!";
				$("#botaoVoltarFixo").html(info);
				// toastGeral("error", "Sem conexão com o servidor!")
			}
		}).done( function(data){
			var numRegistro = data.length == 0 ? "Nenhum Registro" : data.length + " Registro(s)";
			var descricaoBuscando = "";
			// descricaoBuscando += "<h1>Última busca feita</h1>";
			descricaoBuscando += "<p><b>Data:</b><br>&nbsp;&nbsp;&nbsp;&nbsp;"+formatarDataHora(pegarDataHora())+"</p>";
			descricaoBuscando += "<p><b>Numero de Registros:</b><br>&nbsp;&nbsp;&nbsp;&nbsp;"+numRegistro+"</p>";
			$("#buscado").html(descricaoBuscando);
			// console.log(data);
			for(i in data){
				data[i].tipoList = 1;
				consultaGeolocalizacao(data[i]); //  endereco, numero, cidade, cep, data[i].filial, data[i].serie, data[i].nota_fiscal );//codigo);
			}
		});
	}



	function buscarEnderecos2(){
		$.ajax({
			url: urlWebService+"EnderecoWs/listar2"+parametrosWebService,
			type: 'GET',
			contentType: "application/json",
			jsonpCallback: "localJsonpCallback",
			error: function(){
				var info = "<i class='fa fa-asterisk' style='color:red'></i>&nbsp;&nbsp;Sem conexão!";
				$("#botaoVoltarFixo").html(info);
				// toastGeral("error", "Sem conexão com o servidor!")
			}
		}).done( function(data){
			var numRegistro = data.length == 0 ? "Nenhum Registro" : data.length + " Registro(s)";
			var descricaoBuscando = "";
			// descricaoBuscando += "<h1>Última busca feita</h1>";
			descricaoBuscando += "<p><b>Data:</b><br>&nbsp;&nbsp;&nbsp;&nbsp;"+formatarDataHora(pegarDataHora())+"</p>";
			descricaoBuscando += "<p><b>Numero de Registros:</b><br>&nbsp;&nbsp;&nbsp;&nbsp;"+numRegistro+"</p>";
			$("#buscado").html(descricaoBuscando);
			// console.log(data);
			for(i in data){
				// codigo = data[i].codigo;
				data[i].tipoList = 2;
				consultaGeolocalizacao(data[i]);
			}
		});
	}



	var limpaUmaVezUltimoRegistro = true;
	function consultaGeolocalizacao(option){ //  endereco,numero,cidade,cep,filial,serie,nota_fiscal){/*,codigo*/
		var urlGoogleMaps = "https://maps.google.com/maps/api/geocode/json";
		var chaveGoogleMaps = "&key=AIzaSyAhiMsOZoOhu4m5SHG4l_ij6WEHcJdf71A";
		$.ajax({
			type: 'GET',
			url: urlGoogleMaps+"?address="+option.endereco+","+option.numero+","+option.cidade+","+option.cep+chaveGoogleMaps,
			contentType: "application/json",
			jsonpCallback: "localJsonpCallback"
		}).done( function(data){
			if(data.status == "OK"){
				for (var i = 0; i < data.results.length; i++) {
					geometry = data.results[i].geometry;
					for(i in geometry){
						if ( geometry[i].lat != undefined && geometry[i].lng != undefined) {
							option.latitude = geometry[i].lat;
							option.logitude = geometry[i].lng;

							if(limpaUmaVezUltimoRegistro){
								$("#ultimosProcesso").html("");
								limpaUmaVezUltimoRegistro = false;
							}

							var enderecoForm = "<div class='cardEndereco col-xs-12'><hr>";
							enderecoForm += "<p><b>Endereço: </b>"+option.endereco+"</p>";
							enderecoForm += "<p><b>Número: </b>"+option.numero+"</p>";
							enderecoForm += "<p><b>Cidade: </b>"+option.cidade+"</p>";
							enderecoForm += "<p><b>Cep: </b>"+option.cep+"</p>";
							enderecoForm += "<p><b>Latitude: </b>"+option.latitude+"</p>";
							enderecoForm += "<p><b>Longitude: </b>"+option.logitude+"</p>";
							enderecoForm += "</div><br>";

							$("#ultimosProcesso").html(enderecoForm + $("#ultimosProcesso").html());

							setarLatitudeLongitude(option); // latitude,logitude,option.filial,option.serie,option.nota_fiscal, option.tipoList); //, codigo
						}
					}
				}
			} else {
				toastGeral("error", "Endereço Inválido!");
			}
		});
	}


	function setarLatitudeLongitude(option){ // latitude,logitude,filial,serie,nota_fiscal,tipoList){ //, codigo
		console.log("setarLatitudeLongitude");
		var objetoTeste = { 
				"filial": option.filial, 
				"serie": option.serie, 
				"nota_fiscal": option.nota_fiscal, 
				"latitude": option.latitude, 
				"longitude": option.logitude
			};
		console.log( JSON.stringify(objetoTeste) );
		$.ajax({
			type: 'POST',
			cache: false,
			url: urlWebService+"EnderecoWs/inserir" + (option.tipoList == 2 ? "2" : ""),
			dataType: "text",
			contentType: "application/json; charset=utf-8",
			data: JSON.stringify(objetoTeste),
			error: function(){
				var info = "<i class='fa fa-asterisk' style='color:red'></i>&nbsp;&nbsp;Sem conexão!";
				$("#botaoVoltarFixo").html(info);
				toastGeral("error", "Sem conexão com o servidor!")
			}
		}).done( function(data){
			console.log("data: " + data);
		});
	}
</script>

<style type="text/css">
	@media screen and (min-width: 450px)  {
	    [data-role=page]{height: 100% !important; position:relative !important; top:0 !important;}

	    .legenda{
	    	border-style: ridge;
	    	width: 50px;
	    	height: 25px;
	    }
	    .btn {
	    	height: 50px;
	    	font-size: 25px;
	    }
	    .form-control {
	    	height: 50px;
	    	font-size: 35px;
	    }
	    footer {
	    	position: fixed;
	    	height: 60px;
	    	bottom: 0px;
	    	width: 100%;
	    }

	    .fontTable{
	    	font-size: 25px;
	    	color: #fff;
	    }    
	}

	@media screen and (max-width: 450px) {
	    footer {
	    	position: fixed;
	    	height: 45px;
	    	bottom: 0px;
	    	width: 100%;
	    }

	    .fontTable{
	    	font-size: 20px;
	    	color: #fff;
	    }
	}

	.botoesTelaPedidoImprimir{
		color:blue;
	}
</style>
</html>