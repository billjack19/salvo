<!DOCTYPE html>
<html>
<head>
	<!-- 
		Site referencia para achar pontos no Google Maps: 
			- http://www.mapcoordinates.net/pt
	-->
	<meta charset="utf-8">
	<title>Disntâcia entre dois pontos</title>

	<script type="text/javascript" src="js/jQuery.js"></script>

	<link rel="stylesheet" type="text/css" href="css/bootstrap.css">
	<link rel="stylesheet" type="text/css" href="css/estilo.css">
	<link rel="stylesheet" type="text/css" href="css/font-awesome/css/font-awesome.min.css">

	<!-- Scrips padrão -->
	<script type="text/javascript" src="js/scripts.js"></script>
	<script type="text/javascript" src="js/bootstrap.js"></script>

	<script type="text/javascript" src="js/bootbox.js"></script>
	<script type="text/javascript" src="js/masked2.js"></script>
	<script type="text/javascript" src="js/masked.js"></script>
	<script type="text/javascript" src="js/toast.js"></script>
	<script type="text/javascript" src="js/maskmoney.js"></script>
	<script type="text/javascript" src="js/moment.js"></script>

	<!-- Biblioteca dataList usando Jquery  -->
	<link href="lb/jquery-flexdatalist/jquery.flexdatalist.min.css" rel="stylesheet" type="text/css">
	<script src="lb/jquery-flexdatalist/jquery.flexdatalist.min.js"></script>

	<script src="js/jquery.maskMoney.min.js" type="text/javascript"></script>
	<link rel="stylesheet" type="text/css" href="css/toast.css">
</head>
<body onload="buscarEnderecos()">
	<!-- <h1>Distância entre dois pontos</h1>
	<p>Ponto 1: <span id="ponto1"></span></p>
	<p>Ponto 2: <span id="ponto2"></span></p>
	<p>Distância entre eles: <span id="resultadoDistancia"></span></p>
	<p>Pontos central: <span id="pontoCentral"></span></p> -->
	<div id="status" style="background-color: lightgreen"></div>
	<div id="resultado"></div>

	<script type="text/javascript">

var numrequi = 0;
var numrequiComcluida = 0;

var enderecosPesquisados = [];
var enderecoPercorridos = 0;
function buscarEnderecos(){
	$("#resultado").html("Carregando...");
	var resultado = "<table class='table'>";
	resultado += "<tr>";
	resultado += 	"<td><b>Cep</b></td>";
	resultado += 	"<td><b>Endereço</b></td>";
	resultado += 	"<td><b>Bairro</b></td>";
	resultado += 	"<td><b>Cidade</b></td>";
	resultado += 	"<td><b>Regiao</b></td>";
	resultado += "</tr>";
	$.ajax({
		url: 'controllers/funcoesController.php',
		type: 'POST',
		dataType: 'text',
		data: {
			'listarRegioesCEP': true
		}
	}).done( function(data){
		data = JSON.parse(data);
		numrequi = data.length;
		enderecosPesquisados = data;
		for (var i = 0; i < data.length; i++) {
			resultado +=  "<tr>";
			resultado +=  	"<td>"+data[i].cep+"</td>";
			resultado +=  	"<td>"+data[i].endereco+"</td>";
			resultado +=  	"<td>"+data[i].bairro+"</td>";
			resultado +=  	"<td>"+data[i].cidade+"</td>";
			resultado +=  	"<td>"+data[i].id_regiao+" - "+data[i].descricao_regiao+"</td>";
			resultado +=  "</tr>";

			// (data[i].endereco, data[i].bairro, data[i].cidade, data[i].cep, data[i].id_regiao);
		}
		resultado += "</table>";
		/* console.log(data); */
		$("#resultado").html(resultado);
		consultaGeolocalizacao()
	});
}


function consultaGeolocalizacao(){ /* numero */
	if(enderecoPercorridos < enderecosPesquisados.length){
		var endereco = enderecosPesquisados[enderecoPercorridos].endereco.replace(/ /g, "_");
		var bairro = enderecosPesquisados[enderecoPercorridos].bairro.replace(/ /g, "_");
		var bairroOriginal = enderecosPesquisados[enderecoPercorridos].bairro;
		var cidade = enderecosPesquisados[enderecoPercorridos].cidade.replace(/ /g, "_");
		var cidadeOriginal = enderecosPesquisados[enderecoPercorridos].cidade;
		// console.log("cidade nome original: "+cidadeOriginal);
		var cep = enderecosPesquisados[enderecoPercorridos].cep.replace("-", "");
		var id_regiao = enderecosPesquisados[enderecoPercorridos].id_regiao;

		var urlGoogleMaps = "https://maps.google.com/maps/api/geocode/json";
		// var chaveGoogleMaps = "&key=AIzaSyAhiMsOZoOhu4m5SHG4l_ij6WEHcJdf71A"; 
		var chaveGoogleMaps = "&key=AIzaSyATZEPgRLDkT7rt-1otx1yZaugXL_bF2yw";
		var latitude = 0;
		var logitude = 0; /* ,"+bairro+","+numero+" */
		/* Old Requi: urlGoogleMaps+"?address="+endereco+","+cidade+","+cep+chaveGoogleMaps,*/
		$.ajax({
			type: 'GET',
			url: urlGoogleMaps+"?components=administrative_area:"+bairro+"__"+cidade+"|country:BR"+chaveGoogleMaps,
			contentType: "application/json",
			jsonpCallback: "localJsonpCallback"
		}).done( function(data){
			if(data.status == "OK"){
				for (var i = 0; i < data.results.length; i++) {
					geometry = data.results[i].geometry;
					for(i in geometry){
						if ( geometry[i].lat != undefined && geometry[i].lng != undefined) {
							latitude = geometry[i].lat;
							logitude = geometry[i].lng;

							setarLatitudeLongitude(latitude, logitude, id_regiao, bairroOriginal, cidadeOriginal);
						}
					}
				}
			} else {
				toastGeral("error", "Endereço Inválido!");
				document.getElementById("status").style.backgroundColor = "lightred";
			}
		});
	}
}


function setarLatitudeLongitude(latitude, longitude, id_regiao, cep, cidade){
	numrequiComcluida++;
	// console.log("cidade parametro: "+cidade);
	var status = numrequiComcluida >= numrequi ? "Carregado" : "Carregado...";
	$("#status").html("<h1>"+status+": "+numrequiComcluida+"/"+numrequi+"</h1>");

	$.ajax({
		url: 'controllers/funcoesController.php',
		type: 'POST',
		dataType: 'text',
		data: {
			'atualizarPosicao': true,
			'id_regiao': id_regiao,
			'cep': cep,
			'latitude': latitude,
			'longitude': longitude,
			'descricaoAdicional': cidade
		}
	}).done( function(data){
		console.log("setarLatitudeLongitude: " + data);
		enderecoPercorridos++;
		consultaGeolocalizacao();
	});
}

</script>
</body>
</html>